<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reference Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F7F2;
            color: #333;
        }
        .bg-custom-green { background-color: #94B43B; }
        .text-custom-green { color: #94B43B; }
        .border-custom-green { border-color: #94B43B; }
        .hover\:bg-custom-green-dark:hover { background-color: #7c9a2e; }
        .bg-custom-light { background-color: #FFFFFF; }
        .text-custom-dark { color: #2C3E50; }
        .decorative-image {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 450px;
            height: auto;
            opacity: 0.7;
            z-index: 0;
            pointer-events: none;
        }
        @media (max-width: 768px) {
            .decorative-image {
                width: 250px;
                top: 20px;
                right: 10px;
            }
        }
        .focus\:ring-custom-green:focus { --tw-ring-color: #94B43B; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F8F7F2; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Custom Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center; /* Center content horizontally */
            align-items: center; /* Center content vertically */
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .modal-buttons .confirm-btn {
            background-color: #94B43B;
            color: white;
            border: none;
        }
        .modal-buttons .confirm-btn:hover {
            background-color: #7c9a2e;
        }
        .modal-buttons .cancel-btn {
            background-color: #e0e0e0;
            color: #333;
            border: 1px solid #ccc;
        }
        .modal-buttons .cancel-btn:hover {
            background-color: #d0d0d0;
        }
    </style>
</head>
<body class="relative min-h-screen overflow-x-hidden">
    <!-- Image source using the raw GitHub link, with onerror for debugging -->
    <img src="https://raw.githubusercontent.com/project-sync/hr-leadership/main/Ekran%20g%C3%B6r%C3%BCnt%C3%BCs%C3%BC%202025-07-06%20000541.png" alt="Decorative Stripes" class="decorative-image" onerror="console.error('Image failed to load:', this.src)">

    <div class="relative z-10 container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-custom-dark">M7 Course Presentation References</h1>
            <p class="text-lg text-gray-500 mt-2">A minimalist space to store your presentation sources.</p>
        </header>

        <section class="mb-8 md:mb-12 p-4 bg-custom-light rounded-2xl shadow-sm border border-gray-100">
             <h2 class="text-xl font-semibold text-custom-dark">M7 Course: <span class="font-normal">Human Resources Management and Leadership</span></h2>
             <h3 class="text-xl font-semibold text-custom-dark mt-2">University: <span class="font-normal">HTW Berlin</span></h3>
        </section>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1">
                <form id="add-reference-form" class="bg-custom-light p-6 rounded-2xl shadow-sm space-y-4">
                    <h2 class="text-2xl font-semibold text-custom-dark mb-4">Add New Reference</h2>
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-600 mb-1">Title</label>
                        <input type="text" id="title" name="title" required class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-green transition-shadow duration-200" placeholder="">
                    </div>
                    <div>
                        <label for="author" class="block text-sm font-medium text-gray-600 mb-1">Author</label>
                        <input type="text" id="author" name="author" required class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-green transition-shadow duration-200" placeholder="">
                    </div>
                    <div>
                        <label for="pageNumber" class="block text-sm font-medium text-gray-600 mb-1">Page Number</label>
                        <input type="text" id="pageNumber" name="pageNumber" required class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-green transition-shadow duration-200" placeholder="">
                    </div>
                    <div>
                        <label for="link" class="block text-sm font-medium text-gray-600 mb-1">Link</label>
                        <input type="url" id="link" name="link" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-green transition-shadow duration-200" placeholder="https://example.com">
                    </div>
                    <button type="submit" class="w-full bg-custom-green text-white font-bold py-3 px-4 rounded-lg hover:bg-custom-green-dark transition-colors duration-300 shadow-md">
                        Add Reference
                    </button>
                </form>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-custom-light p-6 rounded-2xl shadow-sm mb-6">
                     <h2 class="text-2xl font-bold text-custom-dark">Leading Minds, Not Just Tasks: Transformational Leadership and Effective Communication in Life Sciences</h2>
                     <p class="text-md text-gray-500 mt-2">References mentioned in this presentation, sorted by page number.</p>
                </div>

                <div id="references-list" class="space-y-4">
                    <!-- References will be added here dynamically -->
                </div>
                 <div id="empty-state" class="hidden text-center py-16 px-6 bg-custom-light rounded-2xl shadow-sm">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                    </svg>
                    <h3 class="mt-2 text-xl font-semibold text-custom-dark">No references yet</h3>
                    <p class="mt-1 text-base text-gray-500">Get started by adding a new reference using the form.</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-15 py-6 border-t border-gray-200">
            <p class="text-sm text-gray-500">Developed by: Uğur Ersöz</p>
        </footer>
    </div>

    <!-- Custom Modal HTML -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <p id="modal-message" class="text-lg text-custom-dark"></p>
            <div id="modal-buttons" class="modal-buttons">
                <!-- Buttons will be added here dynamically -->
            </div>
        </div>
    </div>

    <script type="module">
        // Storage Management - Firebase with localStorage fallback
        let useFirebase = false;
        let app, auth, db, refsCollectionRef;

        // Try to initialize Firebase
        try {
            // Import Firebase SDKs
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            const { getAuth, signInAnonymously, signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            const { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                refsCollectionRef = collection(db, `artifacts/${appId}/public/data/references`);
                useFirebase = true;
                console.log("Firebase initialized successfully");
            } else {
                throw new Error("Firebase configuration not available");
            }
        } catch (error) {
            console.warn("Firebase initialization failed, using localStorage fallback:", error.message);
            useFirebase = false;
        }

        // --- Storage Interface ---
        const storage = {
            async addReference(reference) {
                if (useFirebase) {
                    try {
                        const docRef = await addDoc(refsCollectionRef, reference);
                        return docRef.id;
                    } catch (error) {
                        console.error("Firebase add failed, falling back to localStorage:", error);
                        useFirebase = false;
                        return this.addReference(reference);
                    }
                } else {
                    // localStorage fallback
                    const id = 'ref_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const references = this.getReferences();
                    references.push({ id, ...reference });
                    localStorage.setItem('references', JSON.stringify(references));
                    return id;
                }
            },

            async deleteReference(id) {
                if (useFirebase) {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/references`, id));
                        return true;
                    } catch (error) {
                        console.error("Firebase delete failed, falling back to localStorage:", error);
                        useFirebase = false;
                        return this.deleteReference(id);
                    }
                } else {
                    // localStorage fallback
                    const references = this.getReferences();
                    const filteredReferences = references.filter(ref => ref.id !== id);
                    localStorage.setItem('references', JSON.stringify(filteredReferences));
                    return true;
                }
            },

            getReferences() {
                if (useFirebase) {
                    // For Firebase, we'll handle this through the snapshot listener
                    return [];
                } else {
                    // localStorage fallback
                    const stored = localStorage.getItem('references');
                    return stored ? JSON.parse(stored) : [];
                }
            },

            onReferencesChange(callback) {
                if (useFirebase) {
                    try {
                        return onSnapshot(refsCollectionRef, (snapshot) => {
                            const references = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            callback(references);
                        }, (error) => {
                            console.error("Firebase listener error, falling back to localStorage:", error);
                            useFirebase = false;
                            callback(this.getReferences());
                        });
                    } catch (error) {
                        console.error("Firebase listener setup failed:", error);
                        useFirebase = false;
                        callback(this.getReferences());
                    }
                } else {
                    // localStorage fallback - initial load
                    callback(this.getReferences());
                    
                    // Listen for storage changes in other tabs
                    const handleStorageChange = (e) => {
                        if (e.key === 'references') {
                            callback(this.getReferences());
                        }
                    };
                    window.addEventListener('storage', handleStorageChange);
                    
                    // Return cleanup function
                    return () => window.removeEventListener('storage', handleStorageChange);
                }
            }
        };

        // --- Editable Text Management ---
        const textEditor = {
            init() {
                this.setupEditableElements();
                this.loadSavedText();
            },

            setupEditableElements() {
                // Make course title editable
                const courseTitle = document.querySelector('h1');
                if (courseTitle) {
                    this.makeEditable(courseTitle, 'courseTitle');
                }

                // Make course description editable
                const courseDescription = document.querySelector('h2');
                if (courseDescription) {
                    this.makeEditable(courseDescription, 'courseDescription');
                }

                // Make university editable
                const university = document.querySelector('h3');
                if (university) {
                    this.makeEditable(university, 'university');
                }

                // Make presentation title editable
                const presentationTitle = document.querySelector('.lg\\:col-span-2 h2');
                if (presentationTitle) {
                    this.makeEditable(presentationTitle, 'presentationTitle');
                }
            },

            makeEditable(element, key) {
                element.style.cursor = 'pointer';
                element.title = 'Click to edit';
                element.addEventListener('click', () => this.editElement(element, key));
            },

            editElement(element, key) {
                const currentText = element.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentText;
                input.className = element.className + ' border-2 border-custom-green';
                input.style.width = '100%';
                input.style.background = 'white';

                const saveEdit = () => {
                    const newText = input.value.trim();
                    if (newText && newText !== currentText) {
                        element.textContent = newText;
                        localStorage.setItem(key, newText);
                    }
                    element.style.display = 'block';
                    input.remove();
                };

                const cancelEdit = () => {
                    element.style.display = 'block';
                    input.remove();
                };

                input.addEventListener('blur', saveEdit);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') saveEdit();
                    if (e.key === 'Escape') cancelEdit();
                });

                element.style.display = 'none';
                element.parentNode.insertBefore(input, element);
                input.focus();
            },

            loadSavedText() {
                const savedTexts = {
                    courseTitle: localStorage.getItem('courseTitle'),
                    courseDescription: localStorage.getItem('courseDescription'),
                    university: localStorage.getItem('university'),
                    presentationTitle: localStorage.getItem('presentationTitle')
                };

                Object.entries(savedTexts).forEach(([key, value]) => {
                    if (value) {
                        const element = this.getElementByKey(key);
                        if (element) {
                            element.textContent = value;
                        }
                    }
                });
            },

            getElementByKey(key) {
                switch (key) {
                    case 'courseTitle':
                        return document.querySelector('h1');
                    case 'courseDescription':
                        return document.querySelector('h2');
                    case 'university':
                        return document.querySelector('h3');
                    case 'presentationTitle':
                        return document.querySelector('.lg\\:col-span-2 h2');
                    default:
                        return null;
                }
            }
        };

        // --- DOM Elements ---
        const form = document.getElementById('add-reference-form');
        const referencesList = document.getElementById('references-list');
        const emptyState = document.getElementById('empty-state');
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');

        // --- Custom Modal Functions ---
        const showMessage = (message, isConfirm = false) => {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                modalButtons.innerHTML = '';

                const okButton = document.createElement('button');
                okButton.textContent = isConfirm ? 'Confirm' : 'OK';
                okButton.className = 'confirm-btn';
                okButton.onclick = () => {
                    customModal.style.display = 'none';
                    resolve(true);
                };
                modalButtons.appendChild(okButton);

                if (isConfirm) {
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancel';
                    cancelButton.className = 'cancel-btn';
                    cancelButton.onclick = () => {
                        customModal.style.display = 'none';
                        resolve(false);
                    };
                    modalButtons.appendChild(cancelButton);
                }

                customModal.style.display = 'flex';
            });
        };

        // --- Functions ---
        const renderReferences = (references) => {
            referencesList.innerHTML = '';

            if (references.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                
                const sortedReferences = [...references].sort((a, b) => a.pageNumber - b.pageNumber);

                sortedReferences.forEach(ref => {
                    const refElement = document.createElement('div');
                    refElement.className = 'bg-custom-light p-5 rounded-xl shadow-sm border border-gray-100 transform hover:scale-[1.02] transition-transform duration-300';
                    refElement.setAttribute('data-id', ref.id);

                    const formattedDate = new Date(ref.createdAt).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC'
                    });

                    refElement.innerHTML = `
                        <div class="flex justify-between items-start gap-4">
                            <div class="flex-grow">
                                <h3 class="text-xl font-bold text-custom-dark">${ref.title}</h3>
                                <p class="text-md text-gray-600 mt-1">${ref.author}</p>
                                <p class="text-sm text-gray-400 mt-2">${formattedDate}</p>
                                ${ref.link ? `<div class="mt-4"><a href="${ref.link}" target="_blank" rel="noopener noreferrer" class="text-sm text-custom-green hover:underline">Visit Link &rarr;</a></div>` : ''}
                            </div>
                            <div class="text-right flex-shrink-0">
                                 <span class="inline-block bg-custom-green bg-opacity-80 text-white text-sm font-semibold px-3 py-1 rounded-full mb-2">Page ${ref.pageNumber}</span>
                                 <button class="delete-btn text-gray-400 hover:text-red-500 transition-colors duration-200 mt-2 block ml-auto" title="Delete Reference">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    referencesList.appendChild(refElement);
                });
            }
        };

        // --- Event Listeners ---

        // Add new reference when form is submitted
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const addButton = form.querySelector('button[type="submit"]');
            addButton.disabled = true;
            addButton.textContent = 'Adding...';

            const newReference = {
                title: form.title.value.trim(),
                author: form.author.value.trim(),
                link: form.link.value.trim(),
                pageNumber: parseInt(form.pageNumber.value, 10),
                createdAt: new Date().toISOString()
            };

            if (isNaN(newReference.pageNumber)) {
                await showMessage("Error: Page number must be a valid number.");
                addButton.disabled = false;
                addButton.textContent = 'Add Reference';
                return;
            }

            try {
                await storage.addReference(newReference);
                form.reset();
                await showMessage("Reference added successfully!");
                
                // Refresh the references list if using localStorage
                if (!useFirebase) {
                    renderReferences(storage.getReferences());
                }
            } catch (error) {
                console.error("Error adding reference: ", error);
                await showMessage(`An error occurred, reference could not be added. Details: ${error.message || error}`);
            } finally {
                addButton.disabled = false;
                addButton.textContent = 'Add Reference';
            }
        });

        // When delete buttons in the reference list are clicked
        referencesList.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-btn')) {
                const refElement = e.target.closest('[data-id]');
                const refId = refElement.dataset.id;
                
                const confirmed = await showMessage("Are you sure you want to delete this reference?", true);
                if (confirmed) {
                    try {
                        // Delete reference using storage interface
                        await storage.deleteReference(refId);
                    } catch (error) {
                        console.error("Error deleting reference: ", error);
                        await showMessage("An error occurred, reference could not be deleted.");
                    }
                }
            }
        });

        // --- Initialization ---
        
        // Initialize text editor
        textEditor.init();

        // Listen for changes in references
        storage.onReferencesChange((references) => {
            renderReferences(references);
        });
    </script>
</body>
</html>
